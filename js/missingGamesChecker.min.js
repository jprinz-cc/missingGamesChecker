document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#loader"),t=document.querySelector("#platformForm"),n=document.querySelector("#comparisonForm"),l=document.querySelector("#resultContainer"),r=document.querySelector("#missingItemsList"),o=document.querySelector("#property"),a=document.querySelector("#lbPlatformFile"),s=document.querySelector("#platformSelect"),i=document.querySelector("#platformFile"),m=document.querySelector("#metadataFile"),c=document.querySelector("#msglbPlatformFile"),d=document.querySelector("#msgPlatformSelect"),u=document.querySelector("#totalLBGames"),f=document.querySelector("#totalUserGames");function y(){t.style.display="none",n.style.display="none",l.style.display="none",c.innerHTML="",d.innerHTML="",s.selectedIndex=0}a.focus(),o.defaultValue="DatabaseID",a.addEventListener("change",y),s.addEventListener("change",(function(){""!=s.value?(d.innerHTML="OK",n.style.display="block"):(d.innerHTML="",n.style.display="none")})),document.querySelector("#lbPlatformFileForm").addEventListener("submit",(function(n){n.preventDefault(),y();let l=a.files[0],r=new FileReader;r.onload=function(n){e.style.display="block";let l=n.target.result,r=(new DOMParser).parseFromString(l,"text/xml");if("LaunchBox"==r.firstChild.tagName&&"Platform"==r.firstChild.firstElementChild.tagName){let n=r.getElementsByTagName("Platform"),l=[];for(let e=0;e<n.length;e++)l[e]=n[e].firstElementChild.textContent;l.sort(),l=[...new Set(l)],l.forEach((function(e){s.options.add(new Option(e,e))})),e.style.display="none",t.style.display="block",c.innerHTML="OK",c.classList.add("ok"),c.classList.remove("error")}else c.innerHTML="Please select a Launchbox Platforms.xml file.",c.classList.add("error"),c.classList.remove("ok")},r.readAsText(l)})),document.querySelector("#comparisonForm").addEventListener("submit",(function(t){t.preventDefault();let n=m.files[0],a=i.files[0],c=o.value;((t,n)=>new Promise(((l,r)=>{e.style.display="block";let o=new FileReader;o.onload=e=>{let t=e.target.result,o=new DOMParser,a=o.parseFromString(t,"text/xml");const i=[];if("LaunchBox"==a.firstChild.tagName&&"Game"==a.firstChild.firstElementChild.tagName){const e=`//Game[Platform='${s.value}']`,t=a.evaluate(e,a,null,XPathResult.ANY_TYPE,null);let n=t.iterateNext();for(;n;){let e={};e.title=n.querySelector("Name").textContent,e.databaseID=n.querySelector("DatabaseID").textContent,i.push(e),n=t.iterateNext()}}let m=new FileReader;m.onload=function(e){let t=e.target.result,n=o.parseFromString(t,"text/xml").getElementsByTagName("Game"),r=i.length,a=n.length,s=[];for(let e=0;e<i.length-1;e++)if(i[e].databaseID){let t=i[e].databaseID,l=!1;for(let e=0;e<n.length;e++)if(n[e].getElementsByTagName(c)[0]&&n[e].getElementsByTagName(c)[0].textContent===t){l=!0;break}if(!l){let n={};n.databaseID=t,n.title=i[e].title,s.push(n)}}l([s,r,a])},m.onerror=function(e){r(e)},m.readAsText(n)},o.onerror=function(e){r(e)},o.readAsText(t)})))(n,a).then((t=>function(t){e.style.display="none";const n=t[0],o=t[1],a=t[2];if(console.log(o,a),u.innerHTML=o,f.innerHTML=a,""!=r.innerHTML){document.querySelectorAll("#missingItemsList tr").forEach((e=>{e.removeEventListener("mouseover",(e=>{e.target.parentElement.classList.add("active-row")})),e.removeEventListener("mouseout",(e=>{e.target.parentElement.classList.remove("active-row")}))}))}if(r.innerHTML="",0===n.length)r.innerHTML="<tr><td>No missing items found.</td></tr>";else{let e=r.createTHead().insertRow(0),t=e.insertCell(0),l=e.insertCell(1);t.innerHTML="Title",l.innerHTML="DatabaseID";let o=r.createTBody();for(let e=0;e<n.length;e++){let t=o.insertRow(e),l=t.insertCell(0),r=t.insertCell(1);l.innerHTML=n[e].title,r.innerHTML=n[e].databaseID}document.querySelectorAll("#missingItemsList tr").forEach((e=>{e.addEventListener("mouseover",(e=>{e.target.parentElement.classList.add("active-row")})),e.addEventListener("mouseout",(e=>{e.target.parentElement.classList.remove("active-row")}))}))}l.style.display="block"}(t)))}))}));